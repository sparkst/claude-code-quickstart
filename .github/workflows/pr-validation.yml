name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ main ]

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  NODE_OPTIONS: '--max-old-space-size=4096'
  CI: true

jobs:
  # REQ-110 â€” PR-specific validation with fast feedback
  pr-checks:
    name: PR Validation Checks
    runs-on: macos-latest
    if: github.event.pull_request.draft == false
    
    strategy:
      matrix:
        node-version: [20.x]  # Use primary version for PR checks
    
    steps:
    - name: Checkout PR code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        fetch-depth: 0
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci --prefer-offline --no-audit
        echo "Dependencies installed for PR validation"
    
    - name: Quick format check
      run: |
        npm run format:check
        echo "âœ… PR format validation passed"
    
    - name: Quick lint check
      run: |
        npm run lint
        echo "âœ… PR lint validation passed"
    
    - name: Quick security check
      run: |
        npm audit --audit-level=high --production || echo "âš ï¸ Security issues detected - review required"
        echo "âœ… PR security check completed"
    
    - name: Fast test execution
      run: |
        npm run test:run 2>&1 | tee pr-test-results.log
        echo "âœ… PR tests completed"
    
    - name: Upload PR test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pr-test-results
        path: pr-test-results.log
        retention-days: 7

  # REQ-111 â€” Performance impact analysis
  performance-impact:
    name: Performance Impact Analysis
    runs-on: macos-latest
    needs: pr-checks
    if: success()
    
    steps:
    - name: Checkout main branch
      uses: actions/checkout@v4
      with:
        ref: main
        path: main
    
    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        path: pr
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Benchmark main branch
      run: |
        cd main
        npm ci --prefer-offline --no-audit
        echo "ðŸ“Š Benchmarking main branch performance..."
        npm run test:run > ../main-performance.log 2>&1 || true
        echo "Main branch benchmark completed"
    
    - name: Benchmark PR branch
      run: |
        cd pr
        npm ci --prefer-offline --no-audit
        echo "ðŸ“Š Benchmarking PR branch performance..."
        npm run test:run > ../pr-performance.log 2>&1 || true
        echo "PR branch benchmark completed"
    
    - name: Generate performance comparison
      run: |
        echo "# Performance Impact Analysis" > performance-comparison.md
        echo "## Main Branch vs PR Branch" >> performance-comparison.md
        echo "### Main Branch Results:" >> performance-comparison.md
        tail -10 main-performance.log >> performance-comparison.md
        echo "### PR Branch Results:" >> performance-comparison.md
        tail -10 pr-performance.log >> performance-comparison.md
        echo "### Analysis:" >> performance-comparison.md
        echo "- Performance comparison completed" >> performance-comparison.md
        echo "- Check logs for detailed timing information" >> performance-comparison.md
    
    - name: Upload performance analysis
      uses: actions/upload-artifact@v4
      with:
        name: performance-comparison
        path: performance-comparison.md
        retention-days: 30

  # REQ-112 â€” Enhanced PR security validation
  pr-security:
    name: PR Security Validation
    runs-on: macos-latest
    needs: pr-checks
    if: success()
    
    steps:
    - name: Checkout PR code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --prefer-offline --no-audit
    
    - name: Check for sensitive changes
      run: |
        echo "ðŸ” Analyzing PR for sensitive changes..."
        
        # Check for changes in CI/CD files
        if git diff --name-only origin/main..HEAD | grep -E '\.(yml|yaml|json)$' | grep -E '(github|ci|cd|workflow|action)'; then
          echo "âš ï¸ CI/CD configuration changes detected - requires additional review"
        fi
        
        # Check for package.json changes
        if git diff --name-only origin/main..HEAD | grep package.json; then
          echo "âš ï¸ Package configuration changes detected"
          git diff origin/main..HEAD -- package.json
        fi
        
        echo "âœ… Sensitive change analysis completed"
    
    - name: Dependency security audit
      run: |
        echo "ðŸ”’ Running enhanced security audit for PR..."
        npm audit --audit-level=moderate || echo "Security issues found - review required"
        echo "âœ… PR security audit completed"

  # REQ-110 â€” PR summary and feedback
  pr-summary:
    name: PR Summary
    runs-on: macos-latest
    needs: [pr-checks, performance-impact, pr-security]
    if: always()
    
    steps:
    - name: Generate PR summary
      run: |
        echo "## ðŸ” PR Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**PR Number:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
        echo "**Author:** @${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.event.pull_request.head.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Validation Results:" >> $GITHUB_STEP_SUMMARY
        echo "- PR Checks: ${{ needs.pr-checks.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Performance Impact: ${{ needs.performance-impact.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Security Validation: ${{ needs.pr-security.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.pr-checks.result }}" == "success" && "${{ needs.performance-impact.result }}" == "success" && "${{ needs.pr-security.result }}" == "success" ]]; then
          echo "âœ… **All validations passed!** This PR is ready for review." >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Some validations failed.** Please review the results before merging." >> $GITHUB_STEP_SUMMARY
        fi